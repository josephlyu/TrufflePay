<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TrufflePay - AI Buyer Agent</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 16px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
            font-weight: 700;
        }

        .header p {
            font-size: 1.1em;
            opacity: 0.95;
            margin-bottom: 15px;
        }

        .token-info {
            display: inline-block;
            background: rgba(255,255,255,0.2);
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 0.9em;
            margin-top: 10px;
        }

        .token-info a {
            color: white;
            text-decoration: none;
            font-weight: 600;
        }

        .token-info a:hover {
            text-decoration: underline;
        }

        .wallet-balance {
            background: rgba(255,255,255,0.2);
            padding: 8px 16px;
            border-radius: 20px;
            display: inline-block;
            margin-left: 15px;
            font-weight: 600;
        }

        .content {
            padding: 30px;
        }

        .section {
            margin-bottom: 30px;
        }

        .section-title {
            font-size: 1.3em;
            font-weight: 600;
            color: #333;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .step-indicator {
            display: inline-block;
            width: 30px;
            height: 30px;
            background: #667eea;
            color: white;
            border-radius: 50%;
            text-align: center;
            line-height: 30px;
            font-size: 0.9em;
            font-weight: 700;
        }

        .upload-area {
            border: 3px dashed #ddd;
            border-radius: 12px;
            padding: 40px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
            background: #f8f9fa;
        }

        .upload-area:hover {
            border-color: #667eea;
            background: #f0f2ff;
        }

        .upload-area.has-image {
            border-color: #667eea;
            background: #f0f2ff;
        }

        .image-preview {
            max-width: 300px;
            max-height: 300px;
            margin: 20px auto;
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }

        textarea {
            width: 100%;
            min-height: 120px;
            padding: 15px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 1em;
            font-family: inherit;
            resize: vertical;
            transition: border-color 0.3s;
        }

        textarea:focus {
            outline: none;
            border-color: #667eea;
        }

        .btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 15px 40px;
            font-size: 1.1em;
            font-weight: 600;
            border-radius: 8px;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
            margin-top: 20px;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(102, 126, 234, 0.4);
        }

        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .progress-container {
            margin-top: 30px;
            display: none;
        }

        .progress-container.active {
            display: block;
        }

        .progress-step {
            background: #f8f9fa;
            border-left: 4px solid #e0e0e0;
            padding: 20px;
            margin-bottom: 15px;
            border-radius: 8px;
            transition: all 0.3s;
        }

        .progress-step.active {
            border-left-color: #667eea;
            background: #f0f2ff;
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.1);
        }

        .progress-step.completed {
            border-left-color: #4caf50;
            background: #f1f8f4;
        }

        .progress-step-title {
            font-weight: 600;
            color: #333;
            margin-bottom: 8px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .progress-step-content {
            color: #666;
            line-height: 1.6;
        }

        .status-icon {
            font-size: 1.2em;
        }

        .seller-cards {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-top: 15px;
        }

        .seller-card {
            background: white;
            border: 2px solid #e0e0e0;
            border-radius: 12px;
            padding: 20px;
            transition: all 0.3s;
        }

        .seller-card.selected {
            border-color: #667eea;
            background: #f0f2ff;
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.2);
        }

        .seller-card-header {
            font-weight: 700;
            font-size: 1.2em;
            color: #333;
            margin-bottom: 10px;
        }

        .seller-card-price {
            font-size: 1.3em;
            color: #667eea;
            font-weight: 700;
            margin: 10px 0;
        }

        .seller-card-desc {
            color: #666;
            font-size: 0.95em;
            line-height: 1.5;
        }

        .reasoning-box {
            background: #fff9e6;
            border: 2px solid #ffd700;
            border-radius: 8px;
            padding: 15px;
            margin-top: 15px;
        }

        .reasoning-title {
            font-weight: 600;
            color: #b8860b;
            margin-bottom: 8px;
        }

        .tx-link {
            display: inline-block;
            color: #667eea;
            text-decoration: none;
            font-weight: 600;
            padding: 8px 16px;
            background: #f0f2ff;
            border-radius: 6px;
            margin-top: 10px;
            transition: all 0.2s;
        }

        .tx-link:hover {
            background: #667eea;
            color: white;
        }

        .final-result {
            margin-top: 30px;
            padding: 30px;
            background: linear-gradient(135deg, #f0f2ff 0%, #f8f9fa 100%);
            border-radius: 12px;
            text-align: center;
        }

        .result-images {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
            margin-top: 20px;
        }

        .result-image-container {
            background: white;
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }

        .result-image-container h3 {
            margin-bottom: 15px;
            color: #333;
        }

        .result-image-container img {
            max-width: 100%;
            border-radius: 8px;
        }

        .balance-change {
            display: flex;
            justify-content: space-around;
            margin-top: 20px;
            padding: 20px;
            background: white;
            border-radius: 8px;
        }

        .balance-item {
            text-align: center;
        }

        .balance-label {
            font-size: 0.9em;
            color: #666;
            margin-bottom: 5px;
        }

        .balance-value {
            font-size: 1.5em;
            font-weight: 700;
            color: #667eea;
        }

        .balance-value.before {
            color: #999;
        }

        .spinner {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(102, 126, 234, 0.3);
            border-radius: 50%;
            border-top-color: #667eea;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üêæ TrufflePay</h1>
            <p>Decentralized AI Art Marketplace where Agents Negotiate, Pay and Fulfill On-chain via Arbitrum</p>
            <div class="token-info">
                Currency: <a href="https://sepolia.arbiscan.io/token/0x44a7435660d90889b218f7bd0f21884ae01419ac" target="_blank">EncodeToken (ENC)</a>
                <span class="wallet-balance">üí∞ Balance: <span id="walletBalance">--</span> ENC</span>
            </div>
        </div>

        <div class="content">
            <!-- Step 1: Upload Image -->
            <div class="section">
                <div class="section-title">
                    <span class="step-indicator">1</span>
                    Upload Your Dog's Photo
                </div>
                <div class="upload-area" id="uploadArea">
                    <p style="font-size: 1.2em; color: #667eea; margin-bottom: 10px;">üì∏ Click or Drag Image Here</p>
                    <p style="color: #999; font-size: 0.9em;">Upload a photo of your pet</p>
                    <input type="file" id="fileInput" accept="image/*" style="display: none;">
                </div>
                <div id="imagePreview"></div>
            </div>

            <!-- Step 2: Enter Requirements -->
            <div class="section">
                <div class="section-title">
                    <span class="step-indicator">2</span>
                    Describe What You Want
                </div>
                <textarea id="promptInput" placeholder="Enter your requirements (e.g., 'modern art budget 5 ENC, if NFT available can pay up to around 8')"></textarea>
                <button class="btn" id="startBtn" onclick="startBuyerAgent()">üöÄ Start AI Buyer Agent</button>
            </div>

            <!-- Progress Steps -->
            <div class="progress-container" id="progressContainer">
                <div class="section-title" style="margin-bottom: 20px;">
                    <span class="step-indicator">3</span>
                    AI Agent Working...
                </div>
                <div id="progressSteps"></div>
            </div>

            <!-- Final Result -->
            <div id="finalResult"></div>
        </div>
    </div>

    <script>
        let uploadedImage = null;
        let imageBase64 = null;

        // Initialize
        window.onload = async () => {
            await updateWalletBalance();
        };

        // File upload handling
        document.getElementById('uploadArea').addEventListener('click', () => {
            document.getElementById('fileInput').click();
        });

        document.getElementById('fileInput').addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = (event) => {
                    uploadedImage = event.target.result;
                    const uploadArea = document.getElementById('uploadArea');
                    uploadArea.classList.add('has-image');

                    const preview = document.getElementById('imagePreview');
                    preview.innerHTML = `<img src="${uploadedImage}" class="image-preview" alt="Uploaded image">`;

                    // Convert to base64 (remove data URL prefix)
                    imageBase64 = event.target.result.split(',')[1];
                };
                reader.readAsDataURL(file);
            }
        });

        // Get wallet balance
        async function updateWalletBalance() {
            try {
                const response = await fetch('http://localhost:3000/api/buyer-balance');
                const data = await response.json();
                document.getElementById('walletBalance').textContent = data.balance;
            } catch (err) {
                console.error('Failed to fetch balance:', err);
                document.getElementById('walletBalance').textContent = '?';
            }
        }

        // Start buyer agent
        async function startBuyerAgent() {
            if (!uploadedImage) {
                alert('Please upload an image first!');
                return;
            }

            const prompt = document.getElementById('promptInput').value;
            if (!prompt) {
                alert('Please enter your requirements!');
                return;
            }

            const startBtn = document.getElementById('startBtn');
            startBtn.disabled = true;
            startBtn.textContent = '‚è≥ Agent Working...';

            const progressContainer = document.getElementById('progressContainer');
            progressContainer.classList.add('active');

            try {
                // Step 1: Discovery
                addProgressStep('discovery', 'üîç Discovering Service Providers', 'active');

                const registryResponse = await fetch('http://localhost:3000/api/registry');
                const registry = await registryResponse.json();

                updateProgressStep('discovery', `Found ${registry.length} artists in marketplace`, 'completed');
                displaySellerCards(registry);

                // Step 2: AI Analysis
                addProgressStep('analysis', 'ü§ñ AI Agent Analyzing Requirements', 'active');

                const analysisResponse = await fetch('http://localhost:3000/api/analyze-requirements', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ requirements: prompt, registry })
                });
                const analysis = await analysisResponse.json();

                updateProgressStep('analysis', `Selected: ${analysis.seller.name}`, 'completed');
                displayAIReasoning(analysis);

                // Step 3: Request Quote
                addProgressStep('quote', 'üí¨ Requesting Quote', 'active');
                await new Promise(resolve => setTimeout(resolve, 1000));
                updateProgressStep('quote', `Quote received: ${analysis.seller.price} ENC`, 'completed');

                // Step 3.5: MCP Negotiation
                addProgressStep('negotiation', 'ü§ù MCP Negotiation (Buyer & Seller Agents)', 'active');

                const negotiationResponse = await fetch('http://localhost:3000/api/negotiate', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        requirements: prompt,
                        seller: analysis.seller,
                        registry: registry
                    })
                });
                const negotiationResult = await negotiationResponse.json();

                updateProgressStep('negotiation', `Agreement reached: ${negotiationResult.agreedPrice} ENC (saved ${negotiationResult.savings} ENC!)`, 'completed');
                displayNegotiationRounds(negotiationResult);

                // Update seller price with agreed price
                analysis.seller.agreedPrice = negotiationResult.agreedPrice;

                // Step 4: Payment
                addProgressStep('payment', 'üí∞ Processing Payment', 'active');

                const paymentResponse = await fetch('http://localhost:3000/api/purchase', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        imageBase64: imageBase64,
                        seller: analysis.seller,
                        requirements: prompt
                    })
                });
                const result = await paymentResponse.json();

                updateProgressStep('payment', `Payment confirmed! Transaction: ${result.txHash.substring(0, 10)}...`, 'completed');
                displayTransactionLinks(result);

                // Step 5: Delivery
                addProgressStep('delivery', 'üé® Generating Artwork', 'active');
                await new Promise(resolve => setTimeout(resolve, 2000));
                updateProgressStep('delivery', 'Artwork delivered successfully!', 'completed');

                // Show final result
                await displayFinalResult(result, uploadedImage);
                await updateWalletBalance();

            } catch (err) {
                console.error('Error:', err);
                alert('An error occurred: ' + err.message);
            }

            startBtn.disabled = false;
            startBtn.textContent = 'üöÄ Start AI Buyer Agent';
        }

        function addProgressStep(id, title, status) {
            const container = document.getElementById('progressSteps');
            const step = document.createElement('div');
            step.id = `step-${id}`;
            step.className = `progress-step ${status}`;
            step.innerHTML = `
                <div class="progress-step-title">
                    <span class="status-icon">${status === 'active' ? '<span class="spinner"></span>' : status === 'completed' ? '‚úÖ' : '‚è≥'}</span>
                    ${title}
                </div>
                <div class="progress-step-content" id="step-${id}-content"></div>
            `;
            container.appendChild(step);
        }

        function updateProgressStep(id, content, status) {
            const step = document.getElementById(`step-${id}`);
            const contentDiv = document.getElementById(`step-${id}-content`);

            if (status) {
                step.className = `progress-step ${status}`;
                const icon = status === 'completed' ? '‚úÖ' : status === 'active' ? '<span class="spinner"></span>' : '‚è≥';
                step.querySelector('.status-icon').innerHTML = icon;
            }

            if (content) {
                contentDiv.innerHTML = content;
            }
        }

        function displaySellerCards(registry) {
            const content = `
                <div class="seller-cards">
                    ${registry.map(seller => `
                        <div class="seller-card">
                            <div class="seller-card-header">${seller.name}</div>
                            <div class="seller-card-price">${seller.price} ENC <span style="font-size: 0.75em; color: #999; font-weight: 400;">(asking price)</span></div>
                            <div style="padding: 10px; background: #f8f9fa; border-radius: 6px; margin: 8px 0; font-size: 0.85em; line-height: 1.6;">
                                <div><strong>Style:</strong> ${seller.style}</div>
                                <div><strong>NFT:</strong> ${seller.nftIncluded ? '‚úÖ Included' : '‚ùå Not included'}</div>
                                <div><strong>Quality:</strong> ${seller.quality}</div>
                            </div>
                            <div class="seller-card-desc" style="font-size: 0.9em; color: #666; line-height: 1.5;">${seller.description}</div>
                        </div>
                    `).join('')}
                </div>
            `;
            updateProgressStep('discovery', content, null);
        }

        function displayAIReasoning(analysis) {
            const seller = analysis.seller;
            const content = `
                <div class="reasoning-box">
                    <!-- Two Column Layout -->
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; align-items: start;">
                        <!-- Left Column: Selected Artist -->
                        <div>
                            <div class="reasoning-title">‚úÖ Selected Artist: ${seller.name}</div>
                            <div style="background: #f8f9fa; padding: 15px; border-radius: 8px; margin-top: 10px; line-height: 1.8;">
                                <div><strong>Style:</strong> ${seller.style}</div>
                                <div><strong>Asking Price:</strong> ${seller.price} ENC <span style="font-size: 0.85em; color: #999;">(negotiable)</span></div>
                                <div><strong>Description:</strong> ${seller.description}</div>
                                <div><strong>Specialties:</strong> ${seller.specialties ? seller.specialties.join(', ') : 'N/A'}</div>
                                <div><strong>Target Audience:</strong> ${seller.targetAudience || 'N/A'}</div>
                            </div>
                        </div>

                        <!-- Right Column: Agent Reasoning and Budget Analysis -->
                        <div>
                            <div class="reasoning-title">üß† Agent Reasoning & Budget Analysis</div>
                            <div style="margin-top: 10px; padding: 15px; background: #fff9e6; border-left: 4px solid #ffd700; border-radius: 8px;">
                                <div style="font-weight: 600; color: #b8860b; margin-bottom: 8px;">üí° AI Reasoning:</div>
                                <div style="color: #666; margin-bottom: 15px;">${analysis.decision.reasoning}</div>

                                <div style="font-weight: 600; color: #1c7ed6; margin-bottom: 8px;">üí∞ Budget Analysis:</div>
                                <div style="color: #666;">${analysis.decision.budgetJustification}</div>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            updateProgressStep('analysis', content, null);

            // Highlight selected card
            const cards = document.querySelectorAll('.seller-card');
            cards.forEach((card, idx) => {
                if (card.querySelector('.seller-card-header').textContent === seller.name) {
                    card.classList.add('selected');
                }
            });
        }

        function displayNegotiationRounds(negotiation) {
            const rounds = negotiation.negotiationHistory;

            // Build buyer and seller strategy summaries
            const buyerRounds = rounds.filter(r => r.agent === 'buyer');
            const sellerRounds = rounds.filter(r => r.agent === 'seller');

            const buyerStrategy = buyerRounds.map(r => r.reasoning || '').filter(r => r).join(' ');
            const sellerStrategy = sellerRounds.map(r => r.reasoning || '').filter(r => r).join(' ');

            const content = `
                <div style="background: white; padding: 20px; border-radius: 8px; border: 1px solid #e0e0e0;">
                    <div style="font-weight: 700; font-size: 1.15em; margin-bottom: 20px; color: #333; text-align: center;">
                        üí¨ MCP Negotiation Chat
                    </div>

                    <!-- Chat Messages -->
                    <div style="background: #f5f5f5; padding: 15px; border-radius: 8px; margin-bottom: 20px; max-height: 400px; overflow-y: auto;">
                        ${rounds.map((round, idx) => {
                            const isBuyer = round.agent === 'buyer';
                            return `
                                <div style="display: flex; justify-content: ${isBuyer ? 'flex-end' : 'flex-start'}; margin-bottom: 12px;">
                                    <div style="max-width: 70%; ${isBuyer ? 'margin-left: 30%' : 'margin-right: 30%'};">
                                        <div style="font-size: 0.75em; color: #888; margin-bottom: 4px; ${isBuyer ? 'text-align: right' : 'text-align: left'};">
                                            ${isBuyer ? 'üõí You' : 'üé® ' + negotiation.sellerName || 'Seller'}
                                        </div>
                                        <div style="background: ${isBuyer ? 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)' : 'white'};
                                                    color: ${isBuyer ? 'white' : '#333'};
                                                    padding: 12px 16px;
                                                    border-radius: ${isBuyer ? '18px 18px 4px 18px' : '18px 18px 18px 4px'};
                                                    box-shadow: 0 2px 8px rgba(0,0,0,${isBuyer ? '0.15' : '0.08'});
                                                    border: ${isBuyer ? 'none' : '1px solid #e0e0e0'};">
                                            <div style="font-size: 0.95em; line-height: 1.5; margin-bottom: 8px;">
                                                ${round.message}
                                            </div>
                                            <div style="font-weight: 700; font-size: 1.1em; margin-top: 8px; padding-top: 8px; border-top: 1px solid ${isBuyer ? 'rgba(255,255,255,0.3)' : '#e0e0e0'};">
                                                ${isBuyer ?
                                                    `üí∞ ${round.offer} ENC` :
                                                    (round.offer ? `üíµ ${round.offer} ENC` : '‚úÖ Accepted')}
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            `;
                        }).join('')}
                    </div>

                    <!-- Agreement Summary -->
                    <div style="padding: 18px; background: linear-gradient(135deg, #e8f5e9 0%, #c8e6c9 100%); border-radius: 8px; margin-bottom: 20px; box-shadow: 0 2px 8px rgba(76, 175, 80, 0.2);">
                        <div style="font-weight: 700; color: #2E7D32; font-size: 1.1em; margin-bottom: 12px; text-align: center;">
                            ‚úÖ Agreement Reached!
                        </div>
                        <div style="display: flex; justify-content: space-around; gap: 15px; flex-wrap: wrap;">
                            <div style="text-align: center;">
                                <div style="font-size: 0.8em; color: #555; margin-bottom: 4px;">Final Price</div>
                                <div style="font-weight: 700; color: #2E7D32; font-size: 1.4em;">${negotiation.agreedPrice} ENC</div>
                            </div>
                            <div style="text-align: center;">
                                <div style="font-size: 0.8em; color: #555; margin-bottom: 4px;">Original Price</div>
                                <div style="font-weight: 600; color: #666; font-size: 1.2em; text-decoration: line-through;">${negotiation.originalPrice} ENC</div>
                            </div>
                            <div style="text-align: center;">
                                <div style="font-size: 0.8em; color: #555; margin-bottom: 4px;">You Saved</div>
                                <div style="font-weight: 700; color: #388E3C; font-size: 1.4em;">-${negotiation.savings} ENC</div>
                            </div>
                        </div>
                    </div>

                    <!-- Strategic Analysis -->
                    <div style="background: #fafafa; padding: 18px; border-radius: 8px; border: 1px solid #e0e0e0;">
                        <div style="font-weight: 700; font-size: 1.05em; margin-bottom: 15px; color: #333;">
                            üß† Negotiation Strategy Analysis
                        </div>

                        <!-- Buyer Perspective -->
                        <div style="margin-bottom: 15px; padding: 14px; background: linear-gradient(135deg, rgba(102, 126, 234, 0.08) 0%, rgba(118, 75, 162, 0.08) 100%); border-left: 4px solid #667eea; border-radius: 6px;">
                            <div style="font-weight: 600; color: #667eea; margin-bottom: 8px; display: flex; align-items: center; gap: 8px;">
                                <span>üõí</span>
                                <span>Buyer Agent Strategy</span>
                            </div>
                            <div style="color: #444; font-size: 0.9em; line-height: 1.6; text-align: justify;">
                                ${buyerStrategy || 'The buyer agent employed strategic negotiation tactics to secure the best possible price while maintaining a respectful dialogue with the seller. Starting with an anchoring offer below the asking price, the agent progressively increased their offer based on the seller\'s counterproposals, ultimately reaching a mutually beneficial agreement that balanced cost savings with fair compensation for the seller\'s premium service.'}
                            </div>
                        </div>
                    </div>
                </div>
            `;
            updateProgressStep('negotiation', content, null);
        }

        function displayTransactionLinks(result) {
            const content = `
                <div>
                    <a href="https://sepolia.arbiscan.io/tx/${result.txHash}" target="_blank" class="tx-link">
                        View Transaction on Arbiscan ‚Üó
                    </a>
                </div>
            `;
            updateProgressStep('payment', content, null);
        }

        async function displayFinalResult(result, originalImage) {
            const balanceBefore = document.getElementById('walletBalance').textContent;
            await updateWalletBalance();
            const balanceAfter = document.getElementById('walletBalance').textContent;

            document.getElementById('finalResult').innerHTML = `
                <div class="final-result">
                    <h2>üéâ Transaction Complete!</h2>

                    <div class="result-images">
                        <div class="result-image-container">
                            <h3>Original Photo</h3>
                            <img src="${originalImage}" alt="Original">
                        </div>
                        <div class="result-image-container">
                            <h3>Generated Artwork</h3>
                            <img src="${result.portraitUrl}" alt="Generated">
                        </div>
                    </div>

                    <div class="balance-change">
                        <div class="balance-item">
                            <div class="balance-label">Balance Before</div>
                            <div class="balance-value before">${balanceBefore} ENC</div>
                        </div>
                        <div class="balance-item">
                            <div class="balance-label">Amount Paid</div>
                            <div class="balance-value">${result.amount} ENC</div>
                        </div>
                        <div class="balance-item">
                            <div class="balance-label">Balance After</div>
                            <div class="balance-value">${balanceAfter} ENC</div>
                        </div>
                    </div>

                    ${result.nft ? `
                        <div style="margin-top: 25px; padding: 20px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border-radius: 12px; color: white;">
                            <h3 style="margin: 0 0 15px 0; font-size: 1.2em; display: flex; align-items: center; gap: 10px;">
                                <span style="font-size: 1.5em;">üé®</span>
                                NFT Certificate Included!
                            </h3>
                            <div style="background: rgba(255, 255, 255, 0.15); padding: 15px; border-radius: 8px; margin-bottom: 15px;">
                                <div style="display: grid; grid-template-columns: auto 1fr; gap: 10px 15px; font-size: 0.95em;">
                                    <div style="font-weight: 600;">Token ID:</div>
                                    <div style="font-family: monospace;">#${result.nft.tokenId}</div>

                                    <div style="font-weight: 600;">Contract:</div>
                                    <div style="font-family: monospace; font-size: 0.85em; word-break: break-all;">${result.nft.contractAddress}</div>

                                    <div style="font-weight: 600;">Blockchain:</div>
                                    <div>Arbitrum Sepolia</div>
                                </div>
                            </div>
                            <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                                <a href="/nft-viewer.html?tokenId=${result.nft.tokenId}&contract=${result.nft.contractAddress}&image=${encodeURIComponent(result.portraitUrl)}" target="_blank"
                                   style="flex: 1; min-width: 150px; padding: 10px 15px; background: rgba(255, 255, 255, 0.2);
                                          border: 1px solid rgba(255, 255, 255, 0.3); border-radius: 6px; text-decoration: none;
                                          color: white; text-align: center; font-weight: 600; transition: all 0.2s;"
                                   onmouseover="this.style.background='rgba(255, 255, 255, 0.3)'"
                                   onmouseout="this.style.background='rgba(255, 255, 255, 0.2)'">
                                    üñºÔ∏è View NFT Certificate ‚Üó
                                </a>
                                <a href="${result.nft.arbiscanUrl}" target="_blank"
                                   style="flex: 1; min-width: 150px; padding: 10px 15px; background: rgba(255, 255, 255, 0.2);
                                          border: 1px solid rgba(255, 255, 255, 0.3); border-radius: 6px; text-decoration: none;
                                          color: white; text-align: center; font-weight: 600; transition: all 0.2s;"
                                   onmouseover="this.style.background='rgba(255, 255, 255, 0.3)'"
                                   onmouseout="this.style.background='rgba(255, 255, 255, 0.2)'">
                                    View on Arbiscan ‚Üó
                                </a>
                            </div>
                        </div>
                    ` : ''}

                    <div style="margin-top: 20px;">
                        <a href="https://sepolia.arbiscan.io/token/0x44a7435660d90889b218f7bd0f21884ae01419ac?a=0xd612bd8dd7ae4b021145b59cd21289adb80cf682"
                           target="_blank" class="tx-link">
                            View All Buyer Transactions ‚Üó
                        </a>
                    </div>
                </div>
            `;
        }
    </script>
</body>
</html>
